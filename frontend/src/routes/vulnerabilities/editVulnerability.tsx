import PrimaryButton from "../../components/button/PrimaryButton"
import SimpleInput from "../../components/input/SimpleInput";
import SelectDropdown from "../../components/dropdown/SelectDropdown";
import { t } from "i18next"
import { useEffect, useState } from "react";
import TextArea from '../../components/text/TextArea';
import RichText from '../../components/text/RichText';
import { XMarkIcon } from '@heroicons/react/24/outline';
import Modal from "../../components/modal/Modal";
import { updateVulnerability } from "../../services/vulnerabilities";
import { Chip } from "@mui/material";


type Details = {
  locale: string;
  title?: string;
  vulnType?: string;
  description?: string;
  observation?: string;
  remediation?: string;
  cwes: string[];
  references: string[];
  customFields: string[];
} 

type VulnerabilityData = {
  _id: string;
  cvssv3: string | null;
  priority?: number | "";
  remediationComplexity?: number | "";
  details: Details[];
  status?: number;
  category?: string | null; 
  __v: number;
  createdAt?: string;
  updatedAt?: string;
};

interface ListItem {
  id: number;
  value: string;
  label?: string;
  locale?: string;
}

interface addVulnerabilityProps {
  isOpen: boolean;
  handlerIsOpen: React.Dispatch<React.SetStateAction<boolean>>;
  categories: ListItem[];
  languages: ListItem[]
  types: ListItem[];
  refreshVulns: () => void;
  currentVuln: VulnerabilityData;
}


const EditVulnerability: React.FC<addVulnerabilityProps> = ({ isOpen, handlerIsOpen, categories, languages, types, refreshVulns, currentVuln}) => {
  
  const [openModal, setOpenModal] = useState(false)
  const [error, setError] = useState<string | null>(null);
  const [changed, setChanged] = useState<boolean>(false)

  const closeSlidingPage = () => {
    setOpenModal(false);
    handlerIsOpen(false);
  }
  

  const handleSubmitNewVulnerability = async () => {

    const editvulnData : VulnerabilityData = {
      _id: currentVuln._id,
      __v: currentVuln.__v || 0,
      cvssv3: data.cvssv3 !== "" ? data.cvssv3 : null,
      status: currentVuln.status || 0,
      remediationComplexity: data.remediationComplexity || "",
      details: [...details],
      category: categoryChanged === true ? (categorySelected?.value) : (data.category)  || null,
      priority: data.priority || "",
      createdAt: currentVuln.createdAt || new Date().toISOString(),
      updatedAt: new Date().toISOString()
    }
    //console.log(editvulnData)

    //Logica detrás, agregar mensaje Toast
    try {
      const response = await updateVulnerability(editvulnData);
      console.log(response)
    } catch (error) {
      setError("Error creating vulnerability");
      console.error("Error:", error);
    }
   
    refreshVulns();
    handlerIsOpen(!isOpen);
  };


  const complexityOptions = [
    { id: 1, value: t('easy')},
    { id: 2, value: t('medium') },
    { id: 3, value: t('complex') },
  ]

  const priorityOptions = [
    { id: 1, value: t('low')},
    { id: 2, value: t('medium') },
    { id: 3, value: t('high') },
    { id: 4, value: t('urgent') },
  ]

  const [complexity, setComplexity] = useState<ListItem|null>(currentVuln.remediationComplexity ? 
    complexityOptions[currentVuln.remediationComplexity - 1] : null)

  const [priority, setPriority] = useState<ListItem|null>(currentVuln.priority ? 
    complexityOptions[currentVuln.priority - 1] : null)
  
  const [language, setLanguage] = useState<ListItem>(
    languages.find(lang => lang.value === currentVuln.details[0].locale) || languages[0]
  )

  const [type, setType] = useState<ListItem|null>(currentVuln.details[0].vulnType ?
    types.find(typeIter => typeIter.value === currentVuln.details[0].vulnType) || null : null
  )
  const [typesFiltered, setTypesFiltered] = useState<ListItem[]>(
    types.filter(typeIter => typeIter.locale === currentVuln.details[0].locale)
  )
  

  const [categorySelected, setCategorySelected] = useState<ListItem|null>(null)
  const [categoryChanged, setCategoryChanged] = useState<boolean>(false)

  // Recomendación CWE
  const [cweButtonChanged, setCweButtonChanged] = useState<boolean>(false)
  const [cweRecommendation, setCweRecommendation] = useState('')

  const [details, setDetails] = useState<Details[]>(
    currentVuln.details.map(detailIter => ({
      locale: detailIter.locale,
      title: detailIter.title || "",
      vulnType: detailIter.vulnType || "",
      description: detailIter.description || "",
      observation: detailIter.observation || "",
      remediation: detailIter.remediation || "",
      cwes: detailIter.cwes || [],
      references: detailIter.references || [],
      customFields: detailIter.customFields || []
    }))
  );  

  const [detail, setDetail] = useState<Details>({
    locale: currentVuln.details[0].locale,
    title: currentVuln.details[0].title || "",
    vulnType: currentVuln.details[0].vulnType || "",
    description: currentVuln.details[0].description || "",
    observation: currentVuln.details[0].observation || "",
    remediation: currentVuln.details[0].remediation || "",
    cwes: [],
    references: [],
    customFields: []
  })

  const [data, setData] = useState<VulnerabilityData>({
    _id: currentVuln._id,
    __v: currentVuln.__v || 0,
    cvssv3: currentVuln.cvssv3 || "",
    status: currentVuln.status || 0,
    remediationComplexity: currentVuln.remediationComplexity || "",
    details: [],
    category: currentVuln.category || "",
    priority: currentVuln.priority || "",
    createdAt: currentVuln.createdAt || "",
  })


  const addNewDetail = (localeValue: string) => {
    const newDetail: Details = {
      locale: localeValue,
      title: '',
      vulnType: '',
      description: '',
      observation: '',
      remediation: '',
      cwes: [],
      references: [],
      customFields: [],
    };
    setDetail(newDetail)
  }

  const handlerCategoryChange = (item: ListItem) => {
    setCategorySelected(item)
    setCategoryChanged(true)
    changed ? changed : setChanged(true);
  }

  const handleTypeChange = (item: ListItem) => {
    changed ? changed : setChanged(true);
    setDetail((prevDetail) => ({ // CAMBIAR A DETAIL
      ...prevDetail,
      vulnType: item.value
    }))
    setType(item)
  }

  const handleDropdownChange = (name: string, item: ListItem) => {
    changed ? changed : setChanged(true) 
   setData((prevData) => ({
    ...prevData,
    [name]: item.id
   }))

   name === 'priority' ? setPriority(item) : setComplexity(item)
  }

  useEffect(() => {
    // Verificar si el anterior detail exist
    const findLang = details.findIndex(detailLocale => detailLocale.locale === detail.locale)

    // Si el anterior existe, se modifica. Si no, se agrega
    if (findLang !== -1) {
      const updatedDetails = [...details];

      updatedDetails[findLang] = {...detail};
      setDetails(updatedDetails)
    } else {
      details.push(detail)
    }
  },[detail])

  const handleLanguageChange = (item: ListItem) => {
    changed ? changed : setChanged(true) 
    //checkCurrentDetail();
    
    // Verificar si el nuevo detail existe
    const findLangItem = details.findIndex(detailLocale => detailLocale.locale === item.value)

    // Si el nuevo detail existe, se actualiza a ese existente. Si no, se crea uno nuevo!
    findLangItem !== -1 
      ? (setDetail(details[findLangItem]), setType(types.find(typeIter => typeIter.locale === details[findLangItem].locale) || null) )
      : (addNewDetail(item.value), setType(null));
    // Setear nuevo idioma y nuevos types disponibles
    setLanguage(item);

    // Extras al cambiar idioma
    setTypesFiltered(types.filter(typeIter => typeIter.locale === item.value))
  };

  const handleInputChange = (field: string, value: string) => {
    changed ? changed : setChanged(true) 
    setDetail(prevDetail => ({
      ...prevDetail,
      [field]: field === 'cwes' || field === 'references'
      ? value.split('\n')
      : value
      })
    )
  };

  const handleCWERecomendation = () =>{
    // Logica de pegarle al backend usando description 
    // Verificar si description está vacio
    setCweRecommendation("CWE-200")
    setCweButtonChanged(true)
  }

  const handleClickChip = () =>{
    //setCweRecommendation("CWE-200")
    //setCweButtonChanged(true)
    changed ? changed : setChanged(true) 
    setDetail((prevDetail) => ({
      ...prevDetail,
      cwes: [cweRecommendation, ...prevDetail.cwes],
    }));
    setCweButtonChanged(false)
  }
  

  return (
    <>
      <div
        className={`fixed inset-0 bg-black bg-opacity-50 transition-opacity duration-300 ${isOpen ? 'opacity-100' : 'opacity-0'}`}
        onClick={() => changed ? setOpenModal(true) : closeSlidingPage()}
        aria-hidden="true"
      />
      {openModal && 
        <div className="fixed z-10">
          <Modal 
            title={t('msg.doYouWantToLeave')}
            onCancel={() => setOpenModal(false)}
            onSubmit={closeSlidingPage}
            cancelText={t('btn.stay')}
            submitText={t('btn.confirm')}
            isOpen={openModal}
            disablehr={true}
          >
          <></>
          </Modal>
        </div>
      }

      <div
        className={`fixed top-0 right-0 h-full w-1/2 bg-gray-700 shadow-lg transform transition-transform duration-300 ${
          isOpen ? 'translate-x-0 overflow-y-auto' : 'translate-x-full'}`}
      >
        <div className="ml-3 mt-2 flex justify-between items-center">
          <div className="flex items-center">
            <h4 className="text-xl font-bold p-1">{t('editVulnerability')}</h4>
            <span className="px-4 rounded-md border-0 text-white">{currentVuln.category || t('noCategory')}</span>
            <div className="w-px h-12 bg-gray-300"></div>
            <div className="mx-2 relative">
              <SelectDropdown 
                items={categories}
                selected={categorySelected}
                onChange={(value) => handlerCategoryChange(value)}
                placeholder={t('changeCategory')}
                title=""
              />
            </div>
          </div>
          <button
            onClick={() => changed ? setOpenModal(true) : closeSlidingPage()}
            className="bg-transparent text-white p-2 rounded mx-3"
          >
            <XMarkIcon className="h-6 w-6" />
          </button>
        </div>
        <hr className="h-1 my-3 bg-gray-600 border-0 rounded" />
        <div className="flex items-center">
          <div className="w-2/3 p-4">
            <SimpleInput
                label={t('title')}
                id="title"
                name="title"
                type="text"
                placeholder="search"
                value={detail.title || ""}
                onChange={(value) => handleInputChange("title",value)}
            />
          </div>
          <div className="w-1/6 p-4">
            <SelectDropdown 
              title={t('type')} 
              items={typesFiltered}
              selected={type}
              onChange={handleTypeChange}
              placeholder=""
            />
          </div>
          <div className="w-1/6 p-4 relative">
            <SelectDropdown 
              title={t('language')} 
              items={languages}
              selected={language}
              onChange={handleLanguageChange}
            />
          </div>
            
        </div>
        <div>
          <RichText 
            label={t('description')}
            value={detail.description || ""}
            onChange={(value) => handleInputChange("description",value)}
            placeholder={"description"}
          />
        </div>
        <div>
          <RichText 
            label={t('observation')}
            value={detail.observation || ""}
            onChange={(value) => handleInputChange("observation",value)}
            placeholder={"observation"}
          />
        </div>
        <div>
          <RichText 
            label={t('remediation')}
            value={detail.remediation || ""}
            onChange={(value) => handleInputChange("remediation",value)}
            placeholder={"remediation"}
          />
        </div>

        
        
        <div className="flex">
          <div className="w-1/2 p-4">
            <SelectDropdown 
              title={t('remediationComplexity')} 
              items={complexityOptions}
              selected={complexity}
              onChange={(value) => handleDropdownChange("remediationComplexity",value)}
            />
          </div>
          <div className="w-1/2 p-4 relative">
            <SelectDropdown 
              title={t('remediationPriority')} 
              items={priorityOptions}
              selected={priority}
              onChange={(value) => handleDropdownChange("priority",value)}
            />
          </div>
        </div>
        <div>
          <TextArea 
            label={t('references')}
            rows={4}
            value={Array.isArray(detail.references) ? detail.references.join('\n') : detail.references}
            onChange={(value) => handleInputChange("references",value)}
            placeholder={"references"}
            id={"references"}
            name={"references"}
          />
        </div>
        <div>
          <TextArea 
            label={"CWEs"}
            rows={4}
            value={Array.isArray(detail.cwes) ? detail.cwes.join('\n') : detail.cwes}
            onChange={(value) => handleInputChange("cwes",value)}
            placeholder={"cwes"}
            id={"cwes"}
            name={"cwes"}
          />
        </div>
        <div className="mb-2 mx-4 flex">
          <PrimaryButton onClick={handleCWERecomendation}>
            <span>Recommend CWE</span>
          </PrimaryButton>
          {cweButtonChanged && cweRecommendation &&
            <div className="mx-4">
              <Chip
                label={cweRecommendation}
                clickable
                color="primary"
                onDelete={() => setCweButtonChanged(false)}
                onClick={() => handleClickChip()}
              />
            </div>
          }
        </div>
        <div className="mb-2 mx-4 flex justify-end">
          <PrimaryButton onClick={handleSubmitNewVulnerability}>
            <span>{t('editVulnerability')}</span>
          </PrimaryButton>
        </div>
      </div>
      
    </>
  );

};

export default EditVulnerability;