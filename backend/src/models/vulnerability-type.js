var mongoose = require('mongoose');
var Schema = mongoose.Schema;

var VulnerabilityTypeSchema = new Schema({
    name:   String,
    locale: String
}, {timestamps: true});

VulnerabilityTypeSchema.index({"name": 1, "locale": 1}, {name: "unique_name_locale", unique: true})

/*
*** Statics ***
*/

// Get all vulnerabilityTypes
VulnerabilityTypeSchema.statics.getAll = () => {
    return new Promise((resolve, reject) => {
        var query = VulnerabilityType.find();
        query.select('-_id name locale')
        query.exec()
        .then((rows) => {
            resolve(rows);
        })
        .catch((err) => {
            reject(err);
        })
    });
}

// Create vulnerabilityType
VulnerabilityTypeSchema.statics.create = (vulnerabilityType) => {
    return new Promise((resolve, reject) => {
        var query = new VulnerabilityType(vulnerabilityType);
        query.save()
        .then((row) => {
                resolve(row);
        })
        .catch((err) => {
            if (err.code === 11000)
                reject({fn: 'BadParameters', message: 'Vulnerability Type already exists'});
            else
                reject(err);
        })
    })
}

// Update vulnerability Types
VulnerabilityTypeSchema.statics.updateAll = (vulnerabilityTypes) => {
    return new Promise((resolve, reject) => {
        VulnerabilityType.deleteMany()
        .then((row) => {
            VulnerabilityType.insertMany(vulnerabilityTypes)
        })
        .then((row) => {
            resolve("Vulnerability Types updated successfully")
        })
        .catch((err) => {
            reject(err);
        })
    })
}

// Delete vulnerabilityType
VulnerabilityTypeSchema.statics.delete = (name) => {
    return new Promise((resolve, reject) => {
        VulnerabilityType.deleteOne({name: name})
        .then((res) => {
            if (res.deletedCount === 1)
                resolve('Vulnerability Type deleted');
            else
                reject({fn: 'NotFound', message: 'Vulnerability Type not found'});
        })
        .catch((err) => {
            reject(err);
        })
    });
}

/*
*** Methods ***
*/

var VulnerabilityType = mongoose.model('VulnerabilityType', VulnerabilityTypeSchema);
module.exports = VulnerabilityType;